<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chatMapper">


	 <resultMap type="ChatRoom" id="chatRoom_rm">
	        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
	     <id property = "roomNo" column="ROOM_NO"/>
	     <!-- 나머지 일반 컬럼 -->
	      <result property="roomDate" column="ROOM_DATE" />
	      <result property="memberNo" column="MEMBER_NO" />
	      <result property="memberFl" column="MEMBER_FL" />
	      <result property="memberNickname" column="MEMBER_NICKNAME" />
	      <result property="profileImg" column="PROFILE_IMG" />
	      <result property="memberNo2" column="MEMBER_NO2" />
	      <result property="memberFl2" column="MEMBER_FL2" />
	      <result property="memberNickname2" column="MEMBER_NICKNAME2" />
	      <result property="profileImg2" column="PROFILE_IMG2" />
	      <result property="closedFl" column="CLOSED_FL" />
	      <result property="lastChatTime" column="LAST_CHAT_TIME" />
	      <result property="lastChatContent" column="LAST_CHAT_CONTENT" />
	 </resultMap>
	 
	 <resultMap type="Chat" id="chat_rm">
	        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
	     <id property = "roomNo" column="ROOM_NO"/>
	     <!-- 나머지 일반 컬럼 -->
	      <result property="chatNo" column="CHAT_NO" />
	      <result property="chatContent" column="CHAT_CONTENT" />
	      <result property="sendMemberNo" column="SEND_MEMBER_NO" />
	      <result property="chatDelFl" column="CHAT_DEL_FL" />
	      <result property="readFl" column="READ_FL" />
	      <result property="chatDate" column="CHAT_DATE" />
	      <result property="chatTime" column="CHAT_TIME" />
	 </resultMap>
	
	
	
	<!-- 채팅방 목록 -->
	<select id="getChatRoomList" parameterType="_int" resultMap="chatRoom_rm">
		SELECT ROOM_NO, ROOM_DATE, MEMBER_NO, MEMBER_NO2,
			  (SELECT MEMBER_NICKNAME
			  	FROM MEMBER M1
			  	WHERE M1.MEMBER_NO = CR.MEMBER_NO) AS MEMBER_NICKNAME,
			  (SELECT PROFILE_IMG
			   FROM MEMBER M1
			   WHERE M1.MEMBER_NO = CR.MEMBER_NO) AS PROFILE_IMG, 
			  (SELECT MEMBER_NICKNAME
			  	FROM MEMBER M2
			  	WHERE M2.MEMBER_NO = CR.MEMBER_NO2) AS MEMBER_NICKNAME2,
			  (SELECT PROFILE_IMG
			   FROM MEMBER M2
			   WHERE M2.MEMBER_NO = CR.MEMBER_NO2) AS PROFILE_IMG2,
			   (SELECT CASE WHEN TO_CHAR(CHAT_TIME, 'YYYY-MM-DD') = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			   				THEN TO_CHAR(CHAT_TIME, 'AM HH"시" MI"분"')
			   				ELSE TO_CHAR(CHAT_TIME, 'YYYY-MM-DD') END CHAT_TIME
			   FROM (SELECT CHAT_TIME
			   		 FROM CHAT C 
			   		 WHERE C.ROOM_NO = CR.ROOM_NO 
			   		 ORDER BY CHAT_NO DESC)
			   WHERE ROWNUM = 1) AS LAST_CHAT_TIME,
			  (SELECT CHAT_CONTENT
			  FROM (SELECT CHAT_CONTENT
			  		 FROM CHAT C 
			  		 WHERE C.ROOM_NO = CR.ROOM_NO 
			  		 ORDER BY CHAT_NO DESC)
			  WHERE ROWNUM = 1) AS LAST_CHAT_CONTENT
		FROM CHAT_ROOM CR
		WHERE (MEMBER_NO = #{myMemberNo} AND MEMBER_FL = 'N')
		OR (MEMBER_NO2 = #{myMemberNo} AND MEMBER_FL2 = 'N')
	</select>
	
	<!-- 선택한 채팅 내역 가져오기 -->
	<select id="getChatHistory" parameterType="_int" resultMap="chat_rm">
		SELECT CHAT_NO, CHAT_CONTENT, SEND_MEMBER_NO, READ_FL,
			   TO_CHAR(CHAT_TIME, 'YYYY-MM-DD') AS CHAT_DATE,
			   TO_CHAR(CHAT_TIME, 'AM HH":"MI') AS CHAT_TIME
		FROM "CHAT"
		WHERE ROOM_NO = #{roomNo}
		AND CHAT_DEL_FL = 'N'
	</select>
	
	
	<!-- 채팅 보내기 -->
	<insert id="insertChat">
		INSERT INTO CHAT
		VALUES(SEQ_CHAT_NO.NEXTVAL, #{roomNo}, #{chatContent}, #{sendMemberNo},
			   DEFAULT, DEFAULT, DEFAULT)
	</insert>
	
	<!-- 채팅방 정보 가져오기 -->
	<select id="getRoomInfo" parameterType="_int" resultMap="chatRoom_rm">
		SELECT MEMBER_NO, MEMBER_NO2
		FROM CHAT_ROOM
		WHERE ROOM_NO = #{roomNo}
	</select>
	




</mapper>