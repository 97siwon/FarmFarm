<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productAdmin">

<!-- 팜팜 상품 resultMap -->
 	<resultMap type="Product" id="product_rm">	
        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
	     <id property = "productNo" column="PRODUCT_NO"/>
	     <!-- 나머지 일반 컬럼 -->
	      <result property="productName" column="PRODUCT_NAME" />
	      <result property="regDate" column="REG_DATE" />
	      <result property="productPrice" column="PRODUCT_PRICE" />
	      <result property="productAmount" column="PRODUCT_AMOUNT" />
	      <result property="stock" column="STOCK" />
	      <result property="productMessage" column="PRODUCT_MESSAGE" />
	      <result property="categoryNo" column="CATEGORY_NO" />
	      <result property="wishCheck" column="WISH_CHECK" />
	      <result property="soldoutFl" column="SOLDOUT_FL" />
	      <result property="productDelFl" column="PRODUCT_DEL_FL" />
	      <result property="productImgAddress" column="PRODUCT_IMG_ADDRESS" />
	      
 	      <collection property="imgList" 
	      			  javaType="java.util.ArrayList" ofType="ProductImg"
	      			  select="selectImgList"
	      			  column = "PRODUCT_NO"/>
	  </resultMap>
  
  
  
 <!-- 팜팜 상품 이미지 resultMap --> 
	 <resultMap type="ProductImg" id="productImg_rm">
	        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
	     <id property = "productImgNo" column="PRODUCT_IMG_NO"/>
	
	     <!-- 나머지 일반 컬럼 -->
	      <result property="productImgAddress" column="PRODUCT_IMG_ADDRESS" />
	      <result property="productNo" column="PRODUCT_NO" />
	      <result property="productImgOrder" column="PRODUCT_IMG_ORDER" />
	  </resultMap>
  
		
	<!-- 팜팜 상품 등록 -->
	<insert id="enrollProduct" parameterType="Product" useGeneratedKeys="true">
		<selectKey keyProperty="productNo" resultType="_int" order="BEFORE">
			SELECT SEQ_PRODUCT_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO PRODUCT VALUES
		(#{productNo}, #{productName}, DEFAULT, #{productPrice}, 
		DEFAULT, #{categoryNo}, 0, #{productMessage}, DEFAULT)
	</insert>
	
	<!-- 최초 재고 등록 -->
	<insert id="insertStock">
		INSERT INTO STOCK_HISTORY VALUES
		(SEQ_STOCK_NO.NEXTVAL, #{productAmount}, DEFAULT, #{productNo}, 0)
	</insert>
	

	<!-- 팜팜이미지 삽입 -->
	<insert id="insertProductImgList" parameterType="list">
		INSERT INTO PRODUCT_IMG
		SELECT SEQ_PRODUCT_IMG_NO.NEXTVAL POST_IMG_NO, A.* FROM
		<foreach collection="list" item="img" open="(" close=") A" separator="UNION ALL">
			SELECT
				#{img.productImgAddress} PRODUCT_IMG_ADDRESS,
				#{img.productNo} PRODUCT_NO,
				#{img.productImgOrder} PRODUCT_IMG_ORDER
			FROM DUAL
		</foreach>
	</insert>
	
	<!-- 팜팜글 수 조회 -->
	<select id="getListCount" resultType="_int">
		SELECT COUNT(*)
		FROM PRODUCT
	</select>
	
	<select id="selectProductList" resultMap="product_rm">
		SELECT PRODUCT_NO, PRODUCT_NAME, PRODUCT_IMG_ADDRESS,
			STOCK, SOLDOUT_FL,
			TO_CHAR(REG_DATE, 'YYYY-MM-DD') REG_DATE
		FROM PRODUCT
		JOIN PRODUCT_IMG USING(PRODUCT_NO)
		WHERE PRODUCT_IMG_ORDER=0
		AND PRODUCT_DEL_FL='N'
		ORDER BY PRODUCT_NO DESC
	</select>
	
	<!-- 판매자 재고 증가 -->
	<insert id="stockUp">
		INSERT INTO STOCK_HISTORY VALUES
		(SEQ_STOCK_NO.NEXTVAL, #{productAmount}, DEFAULT, #{productNo}, 2)
	</insert>
	
	
	<!-- 판매자 재고 감소 -->
	<insert id="stockDown">
		INSERT INTO STOCK_HISTORY VALUES
		(SEQ_STOCK_NO.NEXTVAL, #{productAmount}, DEFAULT, #{productNo}, 3)
	</insert>
	
	<!-- 판매글 삭제  -->
	<update id="deleteProduct">
		UPDATE PRODUCT SET PRODUCT_DEL_FL='Y' WHERE PRODUCT_NO = #{productNo}
	</update>
	
	<!-- 팜팜 상품 조회 -->
	<select id="selectProductDetail" resultMap="product_rm">
		SELECT PRODUCT_NO, PRODUCT_NAME, 
			TO_CHAR(PRODUCT_PRICE, 'FM999,999,999,999') PRODUCT_PRICE, 
			PRODUCT_MESSAGE, CATEGORY_NO
		FROM PRODUCT
		WHERE PRODUCT_NO = #{productNo}
	</select>
	
	
	<!-- 상품 이미지 목록 조회 -->
 	<select id="selectImgList" resultMap="productImg_rm">
		SELECT * FROM PRODUCT_IMG
		WHERE PRODUCT_NO = #{productNo}
	</select>
	
	
	
</mapper>