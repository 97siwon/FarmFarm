<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productAdmin">

<!-- 팜팜 상품 resultMap -->
 	<resultMap type="Product" id="product_rm">	
        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
	     <id property = "productNo" column="PRODUCT_NO"/>
	     <!-- 나머지 일반 컬럼 -->
	      <result property="productName" column="PRODUCT_NAME" />
	      <result property="regDate" column="REG_DATE" />
	      <result property="productPrice" column="PRODUCT_PRICE" />
	      <result property="stock" column="STOCK" />
	      <result property="productMessage" column="PRODUCT_MESSAGE" />
	      <result property="categoryName" column="CATEGORY_NAME" />
	      <result property="wishCheck" column="WISH_CHECK" />
	      <result property="soldoutFl" column="SOLDOUT_FL" />
	      
	      <collection property="imgList" 
	      			  javaType="java.util.ArrayList" ofType="ProductImg"
	      			  select="selectImgList"
	      			  column = "PRODUCT_NO"/>	  
	  </resultMap>
  
  
  
 <!-- 팜팜 상품 이미지 resultMap --> 
	 <resultMap type="ProductImg" id="productImg_rm">
	        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
	     <id property = "productImgNo" column="PRODUCT_IMG_NO"/>
	
	     <!-- 나머지 일반 컬럼 -->
	      <result property="productImgAddress" column="PRODUCT_IMG_ADDRESS" />
	      <result property="productNo" column="PRODUCT_NO" />
	      <result property="productImgOrder" column="PRODUCT_IMG_ORDER" />
	  </resultMap>
  
	
	<!-- 팜팜 상품 조회 -->
	<select id="selectProduct" resultMap="product_rm">
		SELECT PRODUCT_NO, PRODUCT_NAME, REG_DATE, SOLDOUT_FL,
			TO_CHAR(PRODUCT_PRICE, 'FM999,999,999,999') PRODUCT_PRICE, 
			(STOCK - (SELECT SUM(PRODUCT_AMOUNT) 
			FROM "ORDER" 
			JOIN ORDER_PRODUCT op USING(ORDER_NO) 
			WHERE op.PRODUCT_NO = p.PRODUCT_NO)) STOCK, 
			PRODUCT_MESSAGE, CATEGORY_NAME, #{memberNo} MEMBER_NO,
			(SELECT COUNT(*) FROM WISH w WHERE MEMBER_NO = #{memberNo} AND w.PRODUCT_NO = p.PRODUCT_NO) WISH_CHECK
		FROM PRODUCT p
		JOIN CATEGORY c USING(CATEGORY_NO)
		WHERE PRODUCT_NO = #{productNo}
	</select>
	
	
	<!-- 상품 이미지 목록 조회 -->
	<select id="selectImgList" resultMap="productImg_rm">
		SELECT * FROM PRODUCT_IMG pi2
		WHERE PRODUCT_NO = #{productNo}
	</select>
	
	
	<!-- 팜팜 상품 등록 -->
	<insert id="enrollProduct" parameterType="Product" useGeneratedKeys="true">
		<selectKey keyProperty="productNo" resultType="_int" order="BEFORE">
			SELECT SEQ_PRODUCT_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO PRODUCT VALUES
		(#{prodcutNo}, #{productName}, DEFAULT, #{productPrice}, 
		DEFAULT, #{categoryNo}, #{stock}, #{productMessage})
	</insert>
	

	<!-- 팜팜이미지 삽입 -->
	<insert id="insertProductImgList" parameterType="list">
		INSERT INTO PRODUCT_IMG
		SELECT SEQ_PRODUCT_IMG_NO.NEXTVAL POST_IMG_NO, A.* FROM
		<foreach collection="list" item="img" open="(" close=") A" separator="UNION ALL">
			SELECT
				#{img.productImgAddress} PRODUCT_IMG_ADDRESS,
				#{img.productNo} PRODUCT_NO,
				#{img.productImgOrder} PRODUCT_IMG_ORDER
			FROM DUAL
		</foreach>
	</insert>
	
</mapper>