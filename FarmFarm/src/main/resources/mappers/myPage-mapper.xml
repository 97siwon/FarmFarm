<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myPageMapper">


 <resultMap type="Comment" id="comment_rm">
        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
     <id property = "commentNo" column="COMMENT_NO"/>
     <!-- 나머지 일반 컬럼 -->
      <result property="commentContent" column="COMMENT_CONTENT" />
      <result property="commentCount" column="COMMENT_COUNT" />
      <result property="commentDate" column="COMMENT_DATE" />
      <result property="boardNo" column="BOARD_NO" />
      <result property="boardTitle" column="BOARD_TITLE" />
      <result property="memberNo" column="MEMBER_NO" />
      <result property="commentParent" column="COMMENT_PARENT" />
  </resultMap>
  
   <resultMap type="Order" id="order_rm">
        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
     <id property = "orderNo" column="ORDER_NO"/>
     <!-- 나머지 일반 컬럼 -->
      <result property="memberNo" column="MEMBER_NO" />
      <result property="orderDate" column="ORDER_DATE" />
      <result property="orderStatus" column="ORDER_STATUS" />
      <result property="invoiceNo" column="INVOICE_NO" />
      <result property="orderPrice" column="ORDER_PRICE" />
      
     <collection property="productList" 
		  javaType="java.util.ArrayList" ofType="Product"
		  select="selectProductList"
		  column = "ORDER_NO"/>
  </resultMap>
  
  <!-- 팜팜 상품 resultMap -->
 <resultMap type="Product" id="product_rm">
        <!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그 -->
     <id property = "productNo" column="PRODUCT_NO"/>
     <!-- 나머지 일반 컬럼 -->
      <result property="productName" column="PRODUCT_NAME" />
      <result property="productPrice" column="PRODUCT_PRICE" />
      <result property="productAmount" column="PRODUCT_AMOUNT" />
      <result property="productImg" column="PRODUCT_IMG" />       			  
  </resultMap>
  



<select id="commentCount" resultType="_int">
	SELECT COUNT(*) FROM "COMMENT"
	WHERE MEMBER_NO = #{memberNo}
	AND COMMENT_DEL_FL = 'N'
</select>

<select id="selectCommentList" resultMap="comment_rm">
	SELECT c.COMMENT_NO, c.COMMENT_CONTENT , c.COMMENT_DATE , c.BOARD_NO , b.BOARD_TITLE ,
	(SELECT COUNT(*) FROM "COMMENT" c2 WHERE c2.BOARD_NO = b.BOARD_NO) COMMENT_COUNT 
	FROM "COMMENT" c
	JOIN BOARD b ON (c.BOARD_NO = b.BOARD_NO)
	WHERE c.MEMBER_NO = #{memberNo} AND COMMENT_DEL_FL = 'N'
	ORDER BY c.COMMENT_DATE DESC
</select>

<select id="orderCount" resultType="_int">
	SELECT COUNT(*) FROM "ORDER" WHERE MEMBER_NO = #{memberNo}
</select>

<select id="selectOrderList" resultMap="order_rm">
	SELECT DISTINCT ORDER_NO , ORDER_DATE , ORDER_STATUS , MEMBER_NO , INVOICE_NO, TO_CHAR(ORDER_PRICE, '999,999,999,999') ORDER_PRICE
	FROM "ORDER"
	JOIN ORDER_PRODUCT op USING(ORDER_NO)
	WHERE MEMBER_NO = #{memberNo}
	ORDER BY ORDER_NO DESC
</select>

<select id="selectProductList" resultMap="product_rm">
	SELECT op.PRODUCT_NO , op.PRODUCT_AMOUNT, PRODUCT_NAME, PRODUCT_PRICE,
		(SELECT PRODUCT_IMG_ADDRESS 
		FROM PRODUCT_IMG pi3 
		WHERE pi3.PRODUCT_NO = op.PRODUCT_NO 
		AND PRODUCT_IMG_ORDER = 0) PRODUCT_IMG
	FROM ORDER_PRODUCT op 
	JOIN PRODUCT p ON (op.PRODUCT_NO = p.PRODUCT_NO)
	WHERE ORDER_NO = #{orderNo}
</select>




</mapper>